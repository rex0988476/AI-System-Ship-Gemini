<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆ¹èˆ¶è³‡æ–™åº«æ¸¬è©¦</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: #e5e5e5;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #fff;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .controls {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        .btn-warning {
            background-color: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-danger {
            background-color: #dc2626;
            color: white;
        }

        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-left: auto;
            font-weight: bold;
        }

        .status.running {
            background-color: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .status.stopped {
            background-color: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 0, 0, 0.4);
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #2563eb;
        }

        .stat-title {
            font-size: 14px;
            color: #999;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #fff;
        }

        .vessels-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .vessels-header {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .vessels-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #fff;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            padding: 5px 10px;
            border: 1px solid #444;
            border-radius: 4px;
            background: #333;
            color: #fff;
        }

        .vessels-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .vessel-item {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            transition: background-color 0.2s;
            cursor: pointer;
        }

        .vessel-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .vessel-item.threat-high {
            border-left: 4px solid #dc2626;
            background-color: rgba(220, 38, 38, 0.1);
        }

        .vessel-item.threat-medium {
            border-left: 4px solid #f59e0b;
            background-color: rgba(245, 158, 11, 0.1);
        }

        .vessel-item.threat-low {
            border-left: 4px solid #10b981;
            background-color: rgba(16, 185, 129, 0.1);
        }

        .vessel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .vessel-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
        }

        .vessel-mmsi {
            font-size: 0.9em;
            color: #999;
        }

        .threat-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .threat-high {
            background-color: #dc2626;
            color: white;
        }

        .threat-medium {
            background-color: #f59e0b;
            color: white;
        }

        .threat-low {
            background-color: #10b981;
            color: white;
        }

        .vessel-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: #ccc;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
        }

        .detail-label {
            color: #999;
        }

        .detail-value {
            color: #fff;
            font-weight: bold;
        }

        .ais-active {
            color: #10b981;
        }

        .ais-inactive {
            color: #dc2626;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .alert-banner {
            background: linear-gradient(90deg, #dc2626, #f59e0b);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
            display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¢ èˆ¹èˆ¶è³‡æ–™åº«å³æ™‚ç›£æ§æ¸¬è©¦</h1>

        <div class="alert-banner" id="threatAlert">
            ğŸš¨ æª¢æ¸¬åˆ°é«˜å¨è„…èˆ¹èˆ¶ï¼é»æ“ŠæŸ¥çœ‹è©³æƒ…
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="startMonitoring()">â–¶ï¸ é–‹å§‹ç›£æ§</button>
            <button class="btn btn-warning" onclick="stopMonitoring()">â¸ï¸ åœæ­¢ç›£æ§</button>
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°è³‡æ–™</button>
            <button class="btn btn-danger" onclick="showHighThreatOnly()">âš ï¸ åªé¡¯ç¤ºé«˜å¨è„…</button>
            <button class="btn btn-primary" onclick="showAllVessels()">ğŸ“‹ é¡¯ç¤ºå…¨éƒ¨</button>
            <div class="status stopped" id="statusIndicator">
                ğŸ”´ ç›£æ§å·²åœæ­¢
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- çµ±è¨ˆè³‡æ–™å°‡åœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
        </div>

        <div class="vessels-container">
            <div class="vessels-header">
                <div class="vessels-title">å³æ™‚èˆ¹èˆ¶è³‡è¨Š</div>
                <div class="filter-controls">
                    <select class="filter-select" id="typeFilter" onchange="filterVessels()">
                        <option value="">æ‰€æœ‰é¡å‹</option>
                        <option value="cargo">è²¨èˆ¹</option>
                        <option value="fishing">æ¼èˆ¹</option>
                        <option value="tanker">æ²¹è¼ª</option>
                        <option value="passenger">å®¢èˆ¹</option>
                        <option value="military">è»è‰¦</option>
                        <option value="research">ç ”ç©¶èˆ¹</option>
                    </select>
                    <select class="filter-select" id="countryFilter" onchange="filterVessels()">
                        <option value="">æ‰€æœ‰åœ‹ç±</option>
                        <option value="TW">å°ç£</option>
                        <option value="CN">ä¸­åœ‹</option>
                        <option value="JP">æ—¥æœ¬</option>
                        <option value="KR">éŸ“åœ‹</option>
                        <option value="US">ç¾åœ‹</option>
                    </select>
                </div>
            </div>
            <div class="vessels-list" id="vesselsList">
                <div class="loading">è¼‰å…¥èˆ¹èˆ¶è³‡æ–™ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥èˆ¹èˆ¶è³‡æ–™åº« -->
    <script src="data/vessel_database.js"></script>

    <script>
        let currentFilter = { type: '', country: '', threatOnly: false };
        let vesselDatabase;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç¢ºä¿è³‡æ–™åº«å·²è¼‰å…¥
            setTimeout(() => {
                if (window.vesselDatabase) {
                    vesselDatabase = window.vesselDatabase;
                    refreshData();

                    // ç›£è½å¨è„…è­¦å‘Šäº‹ä»¶
                    window.addEventListener('vesselThreatAlert', handleThreatAlert);

                    console.log('âœ… èˆ¹èˆ¶è³‡æ–™åº«æ¸¬è©¦é é¢å·²åˆå§‹åŒ–');
                } else {
                    console.error('âŒ èˆ¹èˆ¶è³‡æ–™åº«æœªè¼‰å…¥');
                }
            }, 1000);
        });

        function startMonitoring() {
            if (vesselDatabase) {
                vesselDatabase.startDynamicUpdates();
                updateStatusIndicator(true);

                // å®šæœŸåˆ·æ–°é¡¯ç¤º
                setInterval(refreshData, 3000);
            }
        }

        function stopMonitoring() {
            if (vesselDatabase) {
                vesselDatabase.stopDynamicUpdates();
                updateStatusIndicator(false);
            }
        }

        function updateStatusIndicator(isRunning) {
            const indicator = document.getElementById('statusIndicator');
            if (isRunning) {
                indicator.className = 'status running';
                indicator.textContent = 'ğŸŸ¢ ç›£æ§é‹è¡Œä¸­';
            } else {
                indicator.className = 'status stopped';
                indicator.textContent = 'ğŸ”´ ç›£æ§å·²åœæ­¢';
            }
        }

        function refreshData() {
            if (!vesselDatabase) return;

            updateStatistics();
            updateVesselsList();
        }

        function updateStatistics() {
            const stats = vesselDatabase.getStatistics();
            const statsGrid = document.getElementById('statsGrid');

            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-title">ç¸½èˆ¹èˆ¶æ•¸</div>
                    <div class="stat-value">${stats.total}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">é«˜å¨è„…èˆ¹èˆ¶</div>
                    <div class="stat-value" style="color: #dc2626">${stats.byThreatLevel.high}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">AIS é–‹å•Ÿ</div>
                    <div class="stat-value" style="color: #10b981">${stats.aisActive}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">AIS é—œé–‰</div>
                    <div class="stat-value" style="color: #dc2626">${stats.aisInactive}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">ä¸­åœ‹èˆ¹ç±</div>
                    <div class="stat-value">${stats.byCountry.CN || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">è»ç”¨èˆ¹èˆ¶</div>
                    <div class="stat-value">${stats.byType.military || 0}</div>
                </div>
            `;
        }

        function updateVesselsList() {
            let vessels = vesselDatabase.getAllVessels();

            // æ‡‰ç”¨ç¯©é¸
            if (currentFilter.type) {
                vessels = vessels.filter(v => v.type === currentFilter.type);
            }
            if (currentFilter.country) {
                vessels = vessels.filter(v => v.country === currentFilter.country);
            }
            if (currentFilter.threatOnly) {
                vessels = vessels.filter(v => v.threat.level > 60);
            }

            // æŒ‰å¨è„…ç´šåˆ¥æ’åº
            vessels.sort((a, b) => b.threat.level - a.threat.level);

            const vesselsList = document.getElementById('vesselsList');

            if (vessels.length === 0) {
                vesselsList.innerHTML = '<div class="loading">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„èˆ¹èˆ¶</div>';
                return;
            }

            vesselsList.innerHTML = vessels.map(vessel => {
                const threatClass = vessel.threat.riskCategory;
                const distanceToTaiwan = calculateDistance(vessel.position.lat, vessel.position.lon, 24.0, 120.9);

                return `
                    <div class="vessel-item threat-${threatClass}" onclick="showVesselDetails('${vessel.mmsi}')">
                        <div class="vessel-header">
                            <div>
                                <div class="vessel-name">${vessel.name}</div>
                                <div class="vessel-mmsi">MMSI: ${vessel.mmsi}</div>
                            </div>
                            <div class="threat-badge threat-${threatClass}">
                                å¨è„…: ${vessel.threat.level}
                            </div>
                        </div>
                        <div class="vessel-details">
                            <div class="detail-item">
                                <span class="detail-label">é¡å‹:</span>
                                <span class="detail-value">${getVesselTypeText(vessel.type)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">åœ‹ç±:</span>
                                <span class="detail-value">${vessel.flagState}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ä½ç½®:</span>
                                <span class="detail-value">${vessel.position.lat.toFixed(3)}Â°N, ${vessel.position.lon.toFixed(3)}Â°E</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">é€Ÿåº¦:</span>
                                <span class="detail-value">${vessel.position.speed.toFixed(1)} ç¯€</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">èˆªå‘:</span>
                                <span class="detail-value">${vessel.position.course.toFixed(0)}Â°</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">AIS:</span>
                                <span class="detail-value ${vessel.ais.status === 'active' ? 'ais-active' : 'ais-inactive'}">
                                    ${vessel.ais.status === 'active' ? 'ğŸŸ¢ é–‹å•Ÿ' : 'ğŸ”´ é—œé–‰'}
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">è·å°ç£:</span>
                                <span class="detail-value">${distanceToTaiwan.toFixed(1)} km</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æœ€å¾Œæ›´æ–°:</span>
                                <span class="detail-value">${formatTime(vessel.lastSeen)}</span>
                            </div>
                        </div>
                        ${vessel.threat.factors.length > 0 ? `
                            <div style="margin-top: 10px; color: #f59e0b;">
                                âš ï¸ ${vessel.threat.factors.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterVessels() {
            const typeFilter = document.getElementById('typeFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;

            currentFilter.type = typeFilter;
            currentFilter.country = countryFilter;

            updateVesselsList();
        }

        function showHighThreatOnly() {
            currentFilter.threatOnly = true;
            updateVesselsList();
        }

        function showAllVessels() {
            currentFilter = { type: '', country: '', threatOnly: false };
            document.getElementById('typeFilter').value = '';
            document.getElementById('countryFilter').value = '';
            updateVesselsList();
        }

        function showVesselDetails(mmsi) {
            const vessel = vesselDatabase.getVesselByMMSI(mmsi);
            if (vessel) {
                alert(`èˆ¹èˆ¶è©³ç´°è³‡è¨Šï¼š
åç¨±: ${vessel.name}
MMSI: ${vessel.mmsi}
é¡å‹: ${getVesselTypeText(vessel.type)}
åœ‹ç±: ${vessel.flagState}
é•·åº¦: ${vessel.specifications.length}m
å»ºé€ å¹´ä»½: ${vessel.specifications.buildYear}
ç›®çš„åœ°: ${vessel.ais.destination}
å¨è„…ç´šåˆ¥: ${vessel.threat.level}
å¨è„…å› å­: ${vessel.threat.factors.join(', ') || 'ç„¡'}
                `);
            }
        }

        function handleThreatAlert(event) {
            const vessel = event.detail.vessel;
            const alertBanner = document.getElementById('threatAlert');

            alertBanner.textContent = `ğŸš¨ é«˜å¨è„…è­¦å‘Š: ${vessel.name} (${vessel.mmsi}) - å¨è„…ç´šåˆ¥: ${vessel.threat.level}`;
            alertBanner.style.display = 'block';

            // 3ç§’å¾Œéš±è—
            setTimeout(() => {
                alertBanner.style.display = 'none';
            }, 5000);

            console.log('ğŸš¨ æ”¶åˆ°å¨è„…è­¦å‘Š:', vessel.name, vessel.threat.level);
        }

        function getVesselTypeText(type) {
            const types = {
                cargo: 'è²¨èˆ¹',
                fishing: 'æ¼èˆ¹',
                tanker: 'æ²¹è¼ª',
                passenger: 'å®¢èˆ¹',
                military: 'è»è‰¦',
                research: 'ç ”ç©¶èˆ¹'
            };
            return types[type] || type;
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('zh-TW', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // åœ°çƒåŠå¾‘
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>