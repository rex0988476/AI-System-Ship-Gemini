<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èˆ¹èˆ¶è³‡æ–™åº«ç°¡å–®æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #333;
            border-radius: 8px;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
        }
        .vessel-list {
            background: #333;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
        }
        .vessel-item {
            padding: 15px;
            border-bottom: 1px solid #555;
            cursor: pointer;
        }
        .vessel-item:hover {
            background: #444;
        }
        .vessel-item.high-threat {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }
        .vessel-item.medium-threat {
            border-left: 4px solid #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }
        .vessel-item.low-threat {
            border-left: 4px solid #28a745;
            background: rgba(40, 167, 69, 0.1);
        }
        .vessel-name {
            font-weight: bold;
            font-size: 1.1em;
        }
        .vessel-details {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }
        .threat-badge {
            float: right;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .alert {
            background: #dc3545;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        .log {
            background: #222;
            padding: 10px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¢ èˆ¹èˆ¶è³‡æ–™åº«æ¸¬è©¦</h1>

        <div class="alert" id="threatAlert">
            ğŸš¨ å¨è„…è­¦å‘Šå°‡åœ¨æ­¤é¡¯ç¤º
        </div>

        <div class="controls">
            <button class="btn-success" onclick="startTest()">â–¶ï¸ é–‹å§‹æ¸¬è©¦</button>
            <button class="btn-danger" onclick="stopTest()">â¸ï¸ åœæ­¢æ¸¬è©¦</button>
            <button class="btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°è³‡æ–™</button>
            <button class="btn-warning" onclick="showThreatVessels()">âš ï¸ é«˜å¨è„…èˆ¹èˆ¶</button>
            <button class="btn-primary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>

            <div style="margin-top: 10px;">
                <strong>ç‹€æ…‹:</strong> <span id="status">æœªå•Ÿå‹•</span>
            </div>
        </div>

        <div class="stats" id="statsContainer">
            <!-- çµ±è¨ˆè³‡æ–™ -->
        </div>

        <h3>èˆ¹èˆ¶åˆ—è¡¨</h3>
        <div class="vessel-list" id="vesselList">
            <div style="padding: 20px; text-align: center; color: #888;">
                é»æ“Š "é–‹å§‹æ¸¬è©¦" ä¾†è¼‰å…¥èˆ¹èˆ¶è³‡æ–™
            </div>
        </div>

        <h3>ç³»çµ±æ—¥èªŒ</h3>
        <div class="log" id="logContainer">
            <div style="color: #888;">ç­‰å¾…ç³»çµ±å•Ÿå‹•...</div>
        </div>
    </div>

    <!-- è¼‰å…¥èˆ¹èˆ¶è³‡æ–™åº« -->
    <script src="data/vessel_database.js"></script>

    <script>
        let vesselDB = null;
        let isTestRunning = false;
        let updateInterval = null;

        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString('zh-TW');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }

        function startTest() {
            if (isTestRunning) {
                log('âš ï¸ æ¸¬è©¦å·²åœ¨é‹è¡Œä¸­');
                return;
            }

            log('ğŸš€ é–‹å§‹åˆå§‹åŒ–èˆ¹èˆ¶è³‡æ–™åº«...');

            // ç­‰å¾…è³‡æ–™åº«è¼‰å…¥
            setTimeout(() => {
                if (window.vesselDatabase) {
                    vesselDB = window.vesselDatabase;
                    isTestRunning = true;

                    // é–‹å§‹å‹•æ…‹æ›´æ–°
                    vesselDB.startDynamicUpdates();

                    // ç›£è½å¨è„…è­¦å‘Š
                    window.addEventListener('vesselThreatAlert', handleThreatAlert);

                    // å®šæœŸæ›´æ–°é¡¯ç¤º
                    updateInterval = setInterval(refreshData, 2000);

                    document.getElementById('status').textContent = 'ğŸŸ¢ é‹è¡Œä¸­';

                    log(`âœ… è³‡æ–™åº«åˆå§‹åŒ–å®Œæˆï¼Œè¼‰å…¥ ${vesselDB.getAllVessels().length} è‰˜èˆ¹èˆ¶`);
                    log('ğŸ”„ é–‹å§‹å³æ™‚ç›£æ§...');

                    refreshData();
                } else {
                    log('âŒ ç„¡æ³•è¼‰å…¥èˆ¹èˆ¶è³‡æ–™åº«');
                }
            }, 500);
        }

        function stopTest() {
            if (!isTestRunning) {
                log('âš ï¸ æ¸¬è©¦æœªåœ¨é‹è¡Œ');
                return;
            }

            isTestRunning = false;

            if (vesselDB) {
                vesselDB.stopDynamicUpdates();
            }

            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }

            document.getElementById('status').textContent = 'ğŸ”´ å·²åœæ­¢';
            log('ğŸ›‘ æ¸¬è©¦å·²åœæ­¢');
        }

        function refreshData() {
            if (!vesselDB) return;

            updateStats();
            updateVesselList();
        }

        function updateStats() {
            const stats = vesselDB.getStatistics();
            const statsContainer = document.getElementById('statsContainer');

            statsContainer.innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">${stats.total}</div>
                    <div>ç¸½èˆ¹èˆ¶æ•¸</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" style="color: #dc3545;">${stats.byThreatLevel.high}</div>
                    <div>é«˜å¨è„…</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" style="color: #ffc107;">${stats.byThreatLevel.medium}</div>
                    <div>ä¸­å¨è„…</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${stats.aisActive}</div>
                    <div>AIS é–‹å•Ÿ</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" style="color: #dc3545;">${stats.aisInactive}</div>
                    <div>AIS é—œé–‰</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${stats.byCountry.CN || 0}</div>
                    <div>ä¸­åœ‹èˆ¹èˆ¶</div>
                </div>
            `;
        }

        function updateVesselList() {
            const vessels = vesselDB.getAllVessels()
                .sort((a, b) => b.threat.level - a.threat.level)
                .slice(0, 20); // åªé¡¯ç¤ºå‰20è‰˜

            const vesselList = document.getElementById('vesselList');

            vesselList.innerHTML = vessels.map(vessel => {
                const threatClass = vessel.threat.riskCategory;
                const threatBadgeColor = {
                    high: '#dc3545',
                    medium: '#ffc107',
                    low: '#28a745'
                }[threatClass];

                return `
                    <div class="vessel-item ${threatClass}-threat" onclick="showVesselInfo('${vessel.mmsi}')">
                        <div class="vessel-name">
                            ${vessel.name}
                            <span class="threat-badge" style="background: ${threatBadgeColor};">
                                å¨è„…: ${vessel.threat.level}
                            </span>
                        </div>
                        <div class="vessel-details">
                            MMSI: ${vessel.mmsi} |
                            é¡å‹: ${getTypeText(vessel.type)} |
                            åœ‹ç±: ${vessel.country} |
                            ä½ç½®: ${vessel.position.lat.toFixed(2)}Â°N ${vessel.position.lon.toFixed(2)}Â°E |
                            é€Ÿåº¦: ${vessel.position.speed.toFixed(1)}ç¯€ |
                            AIS: ${vessel.ais.status === 'active' ? 'ğŸŸ¢' : 'ğŸ”´'}
                            ${vessel.threat.factors.length > 0 ? ' | âš ï¸ ' + vessel.threat.factors.join(', ') : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showThreatVessels() {
            if (!vesselDB) return;

            const threatVessels = vesselDB.getVesselsByThreatLevel(60);
            log(`âš ï¸ æ‰¾åˆ° ${threatVessels.length} è‰˜é«˜å¨è„…èˆ¹èˆ¶`);

            threatVessels.forEach(vessel => {
                log(`ğŸš¨ ${vessel.name} (${vessel.mmsi}) - å¨è„…: ${vessel.threat.level} - ${vessel.threat.factors.join(', ')}`);
            });
        }

        function showVesselInfo(mmsi) {
            const vessel = vesselDB.getVesselByMMSI(mmsi);
            if (vessel) {
                log(`ğŸš¢ èˆ¹èˆ¶è©³æƒ…: ${vessel.name} (${mmsi})`);
                log(`   ä½ç½®: ${vessel.position.lat.toFixed(4)}Â°N ${vessel.position.lon.toFixed(4)}Â°E`);
                log(`   é€Ÿåº¦: ${vessel.position.speed.toFixed(1)}ç¯€ èˆªå‘: ${vessel.position.course}Â°`);
                log(`   å¨è„…ç´šåˆ¥: ${vessel.threat.level} (${vessel.threat.riskCategory})`);
                log(`   AIS: ${vessel.ais.status} ä¿¡è™Ÿå¼·åº¦: ${vessel.ais.signalStrength.toFixed(1)}dBm`);
                if (vessel.threat.factors.length > 0) {
                    log(`   å¨è„…å› å­: ${vessel.threat.factors.join(', ')}`);
                }
            }
        }

        function handleThreatAlert(event) {
            const vessel = event.detail.vessel;
            const alert = event.detail.alert;

            // é¡¯ç¤ºè­¦å‘Šæ©«å¹…
            const alertElement = document.getElementById('threatAlert');
            alertElement.textContent = `ğŸš¨ å¨è„…è­¦å‘Š: ${vessel.name} (${vessel.mmsi}) - å¨è„…ç´šåˆ¥: ${vessel.threat.level}`;
            alertElement.style.display = 'block';

            // è¨˜éŒ„åˆ°æ—¥èªŒ
            log(`ğŸš¨ <span style="color: #dc3545; font-weight: bold;">å¨è„…è­¦å‘Š</span>: ${vessel.name} (${vessel.mmsi})`);
            log(`   å¨è„…ç´šåˆ¥: ${vessel.threat.level} å› å­: ${vessel.threat.factors.join(', ')}`);

            // 3ç§’å¾Œéš±è—è­¦å‘Š
            setTimeout(() => {
                alertElement.style.display = 'none';
            }, 3000);
        }

        function getTypeText(type) {
            const types = {
                cargo: 'è²¨èˆ¹',
                fishing: 'æ¼èˆ¹',
                tanker: 'æ²¹è¼ª',
                passenger: 'å®¢èˆ¹',
                military: 'è»è‰¦',
                research: 'ç ”ç©¶èˆ¹'
            };
            return types[type] || type;
        }

        // åˆå§‹åŒ–æ—¥èªŒ
        log('ğŸ–¥ï¸ ç³»çµ±å·²è¼‰å…¥ï¼Œé»æ“Š "é–‹å§‹æ¸¬è©¦" ä¾†å•Ÿå‹•èˆ¹èˆ¶ç›£æ§');
    </script>
</body>
</html>